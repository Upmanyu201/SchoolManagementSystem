{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Fee Deposit Management" %} - {{ school_name|default:"School Management" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/consolidated_fees.css' %}">
<link rel="stylesheet" href="{% static 'css/hide-export-buttons.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="animate-fade-in">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-blue-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-money-bill-wave text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-800 bg-clip-text text-transparent">
                        {% trans "Fee Deposit Management" %}
                    </h1>
                    <p class="text-gray-600 mt-1">{% trans "Search and manage student fee payments" %}</p>
                </div>
            </div>
            <div class="flex gap-3">
                <!-- Export Buttons -->
                <div class="flex gap-2">
                    <button onclick="exportData('csv')" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export to CSV">
                        <i class="fas fa-file-csv mr-2"></i>CSV
                    </button>
                    <button onclick="exportData('excel')" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export to Excel">
                        <i class="fas fa-file-excel mr-2"></i>Excel
                    </button>
                    <button onclick="exportData('pdf')" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export to PDF">
                        <i class="fas fa-file-pdf mr-2"></i>PDF
                    </button>
                </div>
                <a href="{% url 'dashboard' %}" 
                   class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                    <i class="fas fa-home mr-2"></i>{% trans "Dashboard" %}
                </a>
            </div>
        </div>
    </div>



    <!-- Messages -->
    {% if messages %}
    <div id="form-messages" class="fixed top-24 right-4 z-50 space-y-2 max-w-md">
        {% for message in messages %}
        <div class="{% if message.tags == 'success' %}bg-green-500{% elif message.tags == 'error' %}bg-red-500{% else %}bg-blue-500{% endif %} text-white p-4 rounded-xl shadow-lg animate-slide-in message-item" data-message-id="{{ forloop.counter }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-3"></i>
                    <span class="font-medium">{{ message }}</span>
                </div>
                <button onclick="removeMessage(this)" class="ml-3 text-white hover:text-gray-200 font-bold">
                    ×
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Search & Filter Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-200">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 rounded-xl mb-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-search mr-3"></i>{% trans "Student Search & Filter" %}
            </h2>
        </div>
        
        <form method="get" class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <!-- Search Input -->
            <div class="form-group lg:col-span-2">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-search mr-2 text-blue-500"></i>{% trans "Search Students" %}
                </label>
                <input type="text" name="q" 
                       placeholder="{% trans 'Search by Admission No, Name, Father Name, or Class...' %}"
                       value="{{ request.GET.q }}"
                       class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-400 focus:ring-0 transition-all duration-300 bg-white"
                       style="color: #1f2937 !important;">
            </div>

            <!-- Search Button -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-search mr-2"></i>{% trans "Search" %}
                </button>
            </div>

            <!-- Clear Button -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                {% if request.GET.q %}
                <a href="{% url 'student_fees:fee_deposit' %}" class="block w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 text-center">
                    <i class="fas fa-times mr-2"></i>{% trans "Clear" %}
                </a>
                {% else %}
                <div class="w-full bg-gray-100 text-gray-400 font-bold py-3 px-6 rounded-xl text-center">
                    <i class="fas fa-broom mr-2"></i>{% trans "Clear" %}
                </div>
                {% endif %}
            </div>
        </form>

        <!-- Search Tips -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
            <h3 class="font-bold text-blue-800 mb-2 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>{% trans "Search Tips" %}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="flex items-center text-blue-700">
                    <i class="fas fa-id-badge mr-2 text-blue-500"></i>
                    <span>{% trans "Admission Number" %}</span>
                </div>
                <div class="flex items-center text-blue-700">
                    <i class="fas fa-user mr-2 text-green-500"></i>
                    <span>{% trans "Student Name" %}</span>
                </div>
                <div class="flex items-center text-blue-700">
                    <i class="fas fa-school mr-2 text-purple-500"></i>
                    <span>{% trans "Class Name" %}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Results -->
    {% if request.GET.q %}
        {% if students %}
        <div class="space-y-6">
            {% for student in students %}
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 student-card hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1" id="student-{{ student.id }}" data-student-id="{{ student.id }}">
                <!-- Student Header -->
                <div class="p-6 flex flex-col lg:flex-row justify-between items-start lg:items-center bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-b-2 border-blue-200">
                    <div class="flex items-center gap-6">
                        {% if student.student_image and student.student_image.url %}
                        <img src="{{ student.student_image.url }}" alt="{{ student.first_name }}" class="w-20 h-20 rounded-full border-4 border-blue-200 shadow-lg object-cover">
                        {% else %}
                        <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                            {{ student.first_name|first }}{{ student.last_name|first }}
                        </div>
                        {% endif %}
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-graduation-cap mr-2 text-blue-500"></i>{{ student.first_name }} {{ student.last_name }}
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                <div class="bg-white rounded-lg px-3 py-2 border border-blue-200">
                                    <span class="flex items-center text-blue-600">
                                        <i class="fas fa-id-badge mr-2"></i>
                                        <strong>{{ student.admission_number }}</strong>
                                    </span>
                                </div>
                                <div class="bg-white rounded-lg px-3 py-2 border border-green-200">
                                    <span class="flex items-center text-green-600">
                                        <i class="fas fa-school mr-2"></i>
                                        <strong>{% if student.class_section %}{{ student.class_section.class_name }}{{ student.class_section.section_name }}{% else %}N/A{% endif %}</strong>
                                    </span>
                                </div>
                                <div class="bg-white rounded-lg px-3 py-2 border border-purple-200">
                                    <span class="flex items-center text-purple-600">
                                        <i class="fas fa-user mr-2"></i>
                                        <strong>{{ student.father_name|default:"-" }}</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 lg:mt-0 flex flex-col sm:flex-row gap-3">
                        <button type="button" 
                                class="view-fees-btn bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg"
                                data-student-id="{{ student.id }}"
                                data-admission-number="{{ student.admission_number }}"
onclick="event.preventDefault(); event.stopPropagation(); console.log('🔍 [CLICK] {{ student.admission_number }}'); loadStudentFees(this)">
                            <i class="fas fa-money-check-alt mr-2"></i>{% trans "Process Payment" %}
                        </button>
                        <a href="{% url 'student_fees:student_fee_preview' student.id %}" 
                           class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                            <i class="fas fa-history mr-2"></i>{% trans "Payment History" %}
                        </a>
                    </div>
                </div>

                <!-- Discount Toggle -->
                <div class="px-6 py-4 border-t border-gray-200" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(21, 128, 61, 0.1));">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="discount-toggle form-checkbox h-5 w-5 text-green-600" 
                               id="discount-toggle-{{ student.id }}">
                        <span class="font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-percentage mr-2 text-green-500"></i>{% trans "Apply Discount" %}
                        </span>
                    </label>
                </div>

                <!-- Fees Container -->
                <div id="fees-container-{{ student.admission_number }}" class="p-6 w-full" style="display: none;">
                    <div class="border-2 border-dashed border-blue-300 rounded-xl p-8 loading-container text-center">
                        <div class="flex justify-center mb-4">
                            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                        </div>
                        <p class="text-lg font-semibold text-gray-700 flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin mr-2 text-blue-500"></i>
                            {% trans "Loading fees data..." %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-200">
            <div class="w-32 h-32 mx-auto mb-6 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
                <i class="fas fa-search text-6xl text-gray-400"></i>
            </div>
            <h3 class="text-3xl font-bold text-gray-700 mb-4"><i class="fas fa-search mr-2"></i>{% trans "No Students Found" %}</h3>
            <p class="text-gray-500 mb-6 text-lg max-w-md mx-auto">
                {% trans "We couldn't find any students matching your search criteria" %} 
                <span class="font-semibold text-blue-600">"{{ request.GET.q }}"</span>
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'student_fees:fee_deposit' %}" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-search mr-2"></i>{% trans "New Search" %}
                </a>
                <a href="{% url 'students:student_list' %}" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-users mr-2"></i>{% trans "View All Students" %}
                </a>
            </div>
        </div>
        {% endif %}
    {% else %}
    <!-- Initial State -->
    <div class="bg-white rounded-2xl shadow-xl p-16 text-center border border-gray-200">
        <div class="w-40 h-40 mx-auto mb-8 bg-gradient-to-r from-blue-100 to-indigo-200 rounded-full flex items-center justify-center">
            <i class="fas fa-search text-8xl text-blue-500"></i>
        </div>
        <h3 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-800 bg-clip-text text-transparent mb-6">
            <i class="fas fa-search mr-3"></i>{% trans "Student Fee Management" %}
        </h3>
        <p class="text-gray-600 mb-8 text-xl max-w-3xl mx-auto leading-relaxed">
            {% trans "Search for students by admission number, name, father's name, or class to process fee payments and view payment history" %}
        </p>
        
        <!-- Feature Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-id-badge text-white"></i>
                </div>
                <h4 class="font-bold text-blue-800 mb-2">{% trans "Admission Number" %}</h4>
                <p class="text-blue-600 text-sm">{% trans "Search by student ID" %}</p>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user text-white"></i>
                </div>
                <h4 class="font-bold text-green-800 mb-2">{% trans "Student Name" %}</h4>
                <p class="text-green-600 text-sm">{% trans "Search by full name" %}</p>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200">
                <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-school text-white"></i>
                </div>
                <h4 class="font-bold text-purple-800 mb-2">{% trans "Class & Section" %}</h4>
                <p class="text-purple-600 text-sm">{% trans "Search by class name" %}</p>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'students:student_list' %}" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                <i class="fas fa-users mr-3"></i>{% trans "Browse All Students" %}
            </a>
            <a href="{% url 'dashboard' %}" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                <i class="fas fa-home mr-3"></i>{% trans "Back to Dashboard" %}
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/consolidated_fees_handler.js' %}"></script>
<script>
// Global function for loadStudentFees with collapse functionality
function loadStudentFees(button) {
    const admissionNumber = button.getAttribute('data-admission-number');
    const studentCard = button.closest('.student-card');
    const targetContainer = studentCard.querySelector('#fees-container-' + admissionNumber);
    
    // Check if fees are already visible
    const isVisible = targetContainer.style.display !== 'none';
    
    // First, collapse all other open fees containers
    document.querySelectorAll('[id^="fees-container-"]').forEach(container => {
        if (container !== targetContainer) {
            container.style.display = 'none';
            // Reset button text for other students
            const otherButton = container.closest('.student-card').querySelector('.view-fees-btn');
            if (otherButton) {
                otherButton.innerHTML = '<i class="fas fa-money-check-alt mr-2"></i>{% trans "Process Payment" %}';
            }
        }
    });
    
    // Toggle current container
    if (isVisible) {
        // Collapse current
        targetContainer.style.display = 'none';
        button.innerHTML = '<i class="fas fa-money-check-alt mr-2"></i>{% trans "Process Payment" %}';
        return;
    }
    
    // Prevent duplicate calls
    if (button.dataset.loading === 'true') {
        console.log('🚫 [BLOCKED] Already loading:', admissionNumber);
        return;
    }
    
    button.dataset.loading = 'true';
    console.log('🚀 [START] Loading fees for:', admissionNumber);
    
    if (!targetContainer) {
        console.error('❌ [ERROR] Container not found for:', admissionNumber);
        button.dataset.loading = 'false';
        return;
    }
    
    // Show container and update button text
    targetContainer.style.display = 'block';
    button.innerHTML = '<i class="fas fa-times mr-2"></i>{% trans "Close Payment" %}';
    
    if (window.consolidatedFeeManager) {
        window.consolidatedFeeManager.loadStudentFeesDirectly(
            button.getAttribute('data-student-id'), 
            admissionNumber, 
            button, 
            targetContainer
        ).finally(() => {
            button.dataset.loading = 'false';
            console.log('✅ [DONE] Finished loading for:', admissionNumber);
        });
    } else {
        button.dataset.loading = 'false';
    }
}

// Auto-hide messages with staggered removal
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 [TEMPLATE] DOM Content Loaded');
    
    const messageItems = document.querySelectorAll('.message-item');
    console.log('🔍 [TEMPLATE] Found message items:', messageItems.length);
    
    messageItems.forEach((item, index) => {
        setTimeout(() => {
            if (item.parentNode) {
                removeMessage(item.querySelector('button'));
            }
        }, 4000 + (index * 500));
    });
    
    // Log fee manager initialization
    if (window.consolidatedFeeManager) {
        console.log('✅ [TEMPLATE] ConsolidatedFeeManager initialized successfully');
    } else {
        console.warn('⚠️ [TEMPLATE] ConsolidatedFeeManager not found');
    }
});

// Export functionality
function exportData(format) {
    console.log('🚀 [STUDENT FEES EXPORT] Starting export process', {
        format: format,
        timestamp: new Date().toISOString(),
        module: 'student_fees'
    });
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;
    
    // Prepare export data
    const exportData = {
        module: 'student_fees',
        data_type: 'fee_deposit_list',
        format: format,
        filters: {
            search: '{{ request.GET.q|default:"" }}'
        }
    };
    
    // Call export API
    const formData = new FormData();
    formData.append('module', exportData.module);
    formData.append('data_type', exportData.data_type);
    formData.append('format', exportData.format);
    formData.append('filters', JSON.stringify(exportData.filters));
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/core/api/export/initiate/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Export feature coming soon', 'success');
        } else {
            showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('💥 [STUDENT FEES EXPORT] Export error:', error);
        showNotification('Export failed: Network error', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function checkExportStatus(requestId, format) {
    const checkStatus = () => {
        fetch(`/core/api/export/status/${requestId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                window.location.href = `/core/api/export/download/${requestId}/`;
                showNotification(`${format.toUpperCase()} export completed!`, 'success');
            } else if (data.status === 'failed') {
                showNotification('Export failed: ' + (data.error || 'Processing error'), 'error');
            } else {
                setTimeout(checkStatus, 2000);
            }
        })
        .catch(error => {
            showNotification('Failed to check export status', 'error');
        });
    };
    setTimeout(checkStatus, 1000);
}

// Message handling functions
function removeMessage(button) {
    const messageItem = button.closest('.message-item');
    messageItem.style.opacity = '0';
    messageItem.style.transform = 'translateX(100%)';
    setTimeout(() => {
        messageItem.remove();
        const container = document.getElementById('form-messages');
        if (container && container.children.length === 0) {
            container.remove();
        }
    }, 300);
}

function showNotification(message, type) {
    // Remove existing export notifications to prevent overlap
    const existingNotifications = document.querySelectorAll('.export-notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `export-notification fixed top-36 right-4 z-50 p-4 rounded-xl shadow-lg animate-slide-in max-w-md ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'
                } mr-3"></i>
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200 font-bold">
                ×
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) notification.remove();
            }, 300);
        }
    }, 4000);
}
</script>
<script src="{% static 'js/hide-export-buttons.js' %}"></script>
{% endblock %}