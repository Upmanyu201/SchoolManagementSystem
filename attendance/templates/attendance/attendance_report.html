{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-blue-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-800 bg-clip-text text-transparent">
                        {% trans "Attendance Report" %}
                    </h1>
                    <p class="text-gray-600 mt-1">{% trans "Generate and view detailed attendance reports" %}</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'attendance:attendance_manage' %}" 
                   class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                    <i class="fas fa-arrow-left mr-2"></i>{% trans "Back" %}
                </a>
                <a href="{% url 'dashboard' %}" 
                   class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                    <i class="fas fa-home mr-2"></i>{% trans "Dashboard" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Search & Filter Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-200">
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 rounded-xl mb-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-calendar-alt mr-3"></i>{% trans "Report Configuration" %}
            </h2>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-calendar mr-2 text-purple-500"></i>{% trans "From Date" %}
                </label>
                <input type="date" id="fromDate" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:ring-0 transition-all duration-300">
            </div>
            
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-indigo-500"></i>{% trans "To Date" %}
                </label>
                <input type="date" id="toDate" class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:ring-0 transition-all duration-300">
            </div>

            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                <button id="fetchReport" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-download mr-2"></i>{% trans "Generate Report" %}
                </button>
            </div>

            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                <button onclick="printReport()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-print mr-2"></i>{% trans "Print Report" %}
                </button>
            </div>

            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>

            </div>
        </div>

        <!-- Stats Display -->
        <div class="mt-6 grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                <div class="flex items-center">
                    <i class="fas fa-school text-blue-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">{% trans "Total Classes" %}</p>
                        <p class="text-xl font-bold text-blue-600" id="totalClasses">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl border border-purple-200">
                <div class="flex items-center">
                    <i class="fas fa-users text-purple-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">{% trans "Total Students" %}</p>
                        <p class="text-xl font-bold text-purple-600" id="totalStudents">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">{% trans "Present" %}</p>
                        <p class="text-xl font-bold text-green-600" id="totalPresent">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-50 to-pink-50 p-4 rounded-xl border border-red-200">
                <div class="flex items-center">
                    <i class="fas fa-times-circle text-red-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">{% trans "Absent" %}</p>
                        <p class="text-xl font-bold text-red-600" id="totalAbsent">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Report Table -->
    <div id="reportTable" class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 hidden">
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-table mr-3"></i>{% trans "Attendance Report" %}
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-school mr-2 text-blue-500"></i>{% trans "Class" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-users mr-2 text-purple-500"></i>{% trans "Total Students" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-check-circle mr-2 text-green-500"></i>{% trans "Present" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-times-circle mr-2 text-red-500"></i>{% trans "Absent" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-percentage mr-2 text-orange-500"></i>{% trans "Attendance %" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-cogs mr-2 text-gray-500"></i>{% trans "Actions" %}
                        </th>
                    </tr>
                </thead>
                <tbody id="reportData">
                    <!-- Report Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-200">
        <div class="flex flex-col items-center">
            <i class="fas fa-calendar-alt text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-500 mb-2">{% trans "No Report Generated" %}</h3>
            <p class="text-gray-400">{% trans "Select a date and click 'Generate Report' to view attendance data" %}</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportDateInput = document.getElementById('reportDate');
    const fetchReportBtn = document.getElementById('fetchReport');
    const reportTable = document.getElementById('reportTable');
    const emptyState = document.getElementById('emptyState');
    const reportData = document.getElementById('reportData');
    
    // Set default date range (last 7 days)
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    document.getElementById('fromDate').value = weekAgo.toISOString().split('T')[0];
    document.getElementById('toDate').value = today.toISOString().split('T')[0];
    
    fetchReportBtn.addEventListener('click', function() {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        
        if (!fromDate || !toDate) {
            alert('{% trans "Please select both dates" %}');
            return;
        }
        
        if (fromDate > toDate) {
            alert('{% trans "From date cannot be later than to date" %}');
            return;
        }
        
        // Show loading state
        fetchReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>{% trans "Loading..." %}';
        fetchReportBtn.disabled = true;
        
        fetch(`/attendance/report/?from_date=${fromDate}&to_date=${toDate}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                reportData.innerHTML = '';
                
                if (data.report && data.report.length > 0) {
                    let totalStudents = 0;
                    let totalPresent = 0;
                    let totalAbsent = 0;
                    
                    data.report.forEach(item => {
                        const attendancePercentage = item.total_students > 0 
                            ? ((item.present / item.total_students) * 100).toFixed(1)
                            : 0;
                        
                        totalStudents += item.total_students;
                        totalPresent += item.present;
                        totalAbsent += item.absent;
                        
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">${item.class_name}</td>
                                <td><span class="badge badge-info">${item.total_students}</span></td>
                                <td><span class="badge badge-success">${item.present}</span></td>
                                <td><span class="badge badge-danger">${item.absent}</span></td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="w-16 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: ${attendancePercentage}%"></div>
                                        </div>
                                        <span class="text-sm font-medium">${attendancePercentage}%</span>
                                    </div>
                                </td>
                                <td>
                                    <button onclick="viewClassDetails('${item.class_name}', '${fromDate}')" 
                                            class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye mr-1"></i>{% trans "Details" %}
                                    </button>
                                </td>
                            </tr>
                        `;
                        reportData.innerHTML += row;
                    });
                    
                    // Update stats
                    document.getElementById('totalClasses').textContent = data.report.length;
                    document.getElementById('totalStudents').textContent = totalStudents;
                    document.getElementById('totalPresent').textContent = totalPresent;
                    document.getElementById('totalAbsent').textContent = totalAbsent;
                    
                    emptyState.classList.add('hidden');
                    reportTable.classList.remove('hidden');
                } else {
                    emptyState.classList.remove('hidden');
                    reportTable.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "Error loading report data" %}');
            })
            .finally(() => {
                fetchReportBtn.innerHTML = '<i class="fas fa-download mr-2"></i>{% trans "Generate Report" %}';
                fetchReportBtn.disabled = false;
            });
    });
});

function viewClassDetails(className, date) {
    fetch(`/attendance/report/?date=${date}&class_name=${encodeURIComponent(className)}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        const students = data.students || [];
        let detailsHtml = `
            <div class="bg-white p-6 rounded-xl max-w-2xl mx-auto">
                <h3 class="text-xl font-bold mb-4 text-center">
                    📊 ${className} - ${date}
                </h3>
                <div class="space-y-2 max-h-96 overflow-y-auto">`;
        
        if (students.length > 0) {
            students.forEach(student => {
                const statusIcon = student.status === 'Present' ? '✅' : '❌';
                const statusClass = student.status === 'Present' ? 'text-green-600' : 'text-red-600';
                detailsHtml += `
                    <div class="flex justify-between items-center p-2 border-b">
                        <span>${student.name}</span>
                        <span class="${statusClass}">${statusIcon} ${student.status}</span>
                    </div>`;
            });
        } else {
            detailsHtml += '<p class="text-center text-gray-500">No attendance data found</p>';
        }
        
        detailsHtml += `</div>
                <button onclick="closeModal()" class="mt-4 w-full btn btn-secondary">
                    Close
                </button>
            </div>`;
        
        showModal(detailsHtml);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading class details');
    });
}

function showModal(content) {
    const modal = document.createElement('div');
    modal.id = 'detailsModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = content;
    document.body.appendChild(modal);
}

function closeModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) modal.remove();
}

function printReport() {
    window.print();
}



// Add print styles
const printStyles = `
    @media print {
        .btn, .card-header button { display: none !important; }
        .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        body { background: white !important; }
    }
`;
const styleSheet = document.createElement("style");
styleSheet.innerText = printStyles;
document.head.appendChild(styleSheet);

// Auto-hide messages and animate elements
document.addEventListener('DOMContentLoaded', function() {
    // Animate table rows on load
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'all 0.5s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
});
</script>

{% block extra_css %}
<style>
.animate-fade-in {
    animation: fadeIn 0.8s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced form styling */
.form-input {
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    box-shadow: inset 2px 2px 5px #e2e8f0, inset -2px -2px 5px #ffffff;
}

.form-input:focus {
    background: #ffffff;
    box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
}

/* Table enhancements */
tbody tr:hover {
    background: linear-gradient(to right, rgba(147, 51, 234, 0.05), rgba(79, 70, 229, 0.05));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Badge styling */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-info {
    background: linear-gradient(135deg, #06B6D4, #0891B2);
    color: white;
}

.badge-success {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
}

.badge-danger {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
}
</style>
{% endblock %}
{% endblock %}