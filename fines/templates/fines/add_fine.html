{% extends 'fines/base_fine.html' %}
{% load static %}
{% load i18n %}

{% block fine_content %}
<div class="animate-fade-in">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-red-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-pink-800 bg-clip-text text-transparent">
                        üí∏ {% trans "Add New Fine" %}
                    </h1>
                    <p class="text-gray-600 mt-1">üìã {% trans "Apply fines to students for various violations" %}</p>
                </div>
            </div>
            <a href="{% url 'fines:fine_history' %}" 
               class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                <i class="fas fa-arrow-left mr-2"></i>{% trans "Back to History" %}
            </a>
        </div>
    </div>

    <!-- Fine Form -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
        <div class="bg-gradient-to-r from-red-500 to-pink-600 p-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-edit mr-3"></i>{% trans "Fine Configuration Form" %}
            </h2>
        </div>
        <form method="post" enctype="multipart/form-data" class="p-8">
            {% csrf_token %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Fine Type Section -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-tags mr-2 text-red-500"></i>{% trans "Fine Type" %}*
                        </label>
                        {{ form.fine_type }}
                        <div id="fine-type-description" class="mt-2 text-sm text-gray-500 italic"></div>
                    </div>

                    <!-- Amount Configuration -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-rupee-sign mr-2 text-green-500"></i>{% trans "Amount Configuration" %}
                        </label>
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-xl border border-r-0 border-gray-300 bg-gray-50 text-gray-500">‚Çπ</span>
                                    <input type="number" name="amount" id="id_amount" step="0.01" placeholder="{% trans 'Fixed Amount' %}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-r-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                                </div>
                            </div>
                            <span class="text-gray-400">{% trans "or" %}</span>
                            <div class="flex-1">
                                <div class="flex">
                                    <input type="number" name="dynamic_amount_percent" id="id_dynamic_amount_percent" step="0.01" placeholder="{% trans 'Percentage' %}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-l-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                                    <span class="inline-flex items-center px-3 rounded-r-xl border border-l-0 border-gray-300 bg-gray-50 text-gray-500">%</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">{% trans "Enter either fixed amount or percentage (not both)" %}</p>
                    </div>

                    <!-- Fees Group -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-layer-group mr-2 text-blue-500"></i>üìã {% trans "Fees Group" %}
                        </label>
                        {{ form.fees_group }}
                    </div>

                    <!-- Fees Type -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-list mr-2 text-purple-500"></i>üìù {% trans "Fees Type" %}
                        </label>
                        <select name="fees_type" id="id_fees_type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300" disabled>
                            <option value="">{% trans "Select Fees Group first" %}</option>
                        </select>
                        <div id="fees-type-info" class="mt-2 text-sm text-gray-500 italic"></div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Target Scope Section -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-bullseye mr-2 text-orange-500"></i>üéØ {% trans "Target Scope" %}*
                        </label>
                        <div class="grid grid-cols-1 gap-3">
                            <label class="inline-flex items-center p-4 border-2 rounded-xl hover:bg-blue-50 cursor-pointer transition-all duration-300 {% if form.target_scope.value == 'Individual' %}border-blue-500 bg-blue-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="target_scope" value="Individual" class="form-radio h-5 w-5 text-blue-600" {% if form.target_scope.value == 'Individual' %}checked{% endif %}>
                                <div class="ml-4">
                                    <span class="block text-sm font-semibold text-gray-700">{% trans "Individual Students" %}</span>
                                    <span class="block text-xs text-gray-500">{% trans "Apply to selected students" %}</span>
                                </div>
                            </label>
                            <label class="inline-flex items-center p-4 border-2 rounded-xl hover:bg-green-50 cursor-pointer transition-all duration-300 {% if form.target_scope.value == 'Class' %}border-green-500 bg-green-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="target_scope" value="Class" class="form-radio h-5 w-5 text-green-600" {% if form.target_scope.value == 'Class' %}checked{% endif %}>
                                <div class="ml-4">
                                    <span class="block text-sm font-semibold text-gray-700">{% trans "Entire Class" %}</span>
                                    <span class="block text-xs text-gray-500">{% trans "Apply to entire class" %}</span>
                                </div>
                            </label>
                            <label class="inline-flex items-center p-4 border-2 rounded-xl hover:bg-purple-50 cursor-pointer transition-all duration-300 {% if form.target_scope.value == 'All' %}border-purple-500 bg-purple-50{% else %}border-gray-300{% endif %}">
                                <input type="radio" name="target_scope" value="All" class="form-radio h-5 w-5 text-purple-600" {% if form.target_scope.value == 'All' %}checked{% endif %}>
                                <div class="ml-4">
                                    <span class="block text-sm font-semibold text-gray-700">üåç {% trans "All Students" %}</span>
                                    <span class="block text-xs text-gray-500">{% trans "Apply to all students" %}</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Date Fields -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-indigo-500"></i>üìÖ {% trans "Due Date" %}*
                        </label>
                        <input type="date" name="due_date" id="id_due_date" value="{{ form.due_date.value|default:'' }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                    </div>

                    <!-- Delay Days -->
                    <div class="form-group">
                        <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-clock mr-2 text-yellow-500"></i>‚è∞ {% trans "Delay Days" %}
                        </label>
                        <input type="number" name="delay_days" id="id_delay_days" value="{{ form.delay_days.value|default:'0' }}" min="0" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                        <p class="text-xs text-gray-500 mt-1">{% trans "Days after due date when fine will be applied (0 for immediate)" %}</p>
                    </div>
                </div>
            </div>

            <!-- Conditional Fields -->
            <div id="student-field" class="form-group mt-8 {% if form.target_scope.value != 'Individual' %}hidden{% endif %}">
                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                    <i class="fas fa-user-check mr-2 text-blue-500"></i>{% trans "Select Students" %}*
                </label>
                
                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="student-search" placeholder="{% trans 'Search students by name, admission number, father name, or class...' %}" class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Student Selection -->
                <div class="border-2 border-gray-200 rounded-xl p-4 max-h-60 overflow-y-auto bg-gray-50">
                    <div id="student-list" class="space-y-2">
                        <!-- Students will be loaded here -->
                    </div>
                </div>
                
                <!-- Selected Students Display -->
                <div id="selected-students" class="mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>{% trans "Selected Students" %}:
                    </label>
                    <div id="selected-students-list" class="space-y-2">
                        <!-- Selected students will be shown here -->
                    </div>
                </div>
                
                <!-- Hidden input for form submission -->
                <input type="hidden" name="selected_students" id="selected_students_input" value="">
                
                <!-- Validation message -->
                <div id="student-validation-error" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm hidden flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    {% trans "Please select at least one student." %}
                </div>
            </div>

            <div id="class-field" class="form-group mt-8 {% if form.target_scope.value != 'Class' %}hidden{% endif %}">
                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                    <i class="fas fa-school mr-2 text-green-500"></i>{% trans "Select Class" %}*
                </label>
                <select name="class_section" id="id_class_section" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300">
                    <option value="">{% trans "Select Class" %}</option>
                    {% for class in form.class_section.field.queryset %}
                    <option value="{{ class.id }}" {% if form.class_section.value == class.id %}selected{% endif %}>
                        {{ class.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Reason -->
            <div class="form-group mt-8">
                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                    <i class="fas fa-comment-alt mr-2 text-purple-500"></i>{% trans "Reason" %}*
                </label>
                <textarea name="reason" id="id_reason" rows="4" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:ring-0 transition-all duration-300" placeholder="{% trans 'Enter the reason for applying this fine...' %}">{{ form.reason.value|default:'' }}</textarea>
            </div>

            <!-- Notification Channels -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                    <i class="fas fa-bell mr-2 text-yellow-500"></i>üîî {% trans "Notification Channels" %}
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="inline-flex items-center p-3 border-2 rounded-xl hover:bg-blue-50 cursor-pointer transition-all duration-300">
                        <input type="checkbox" name="channels" value="sms" class="form-checkbox h-5 w-5 text-blue-600">
                        <span class="ml-3 flex items-center">
                            <i class="fas fa-sms mr-2 text-blue-500"></i>{% trans "SMS" %}
                        </span>
                    </label>
                    <label class="inline-flex items-center p-3 border-2 rounded-xl hover:bg-green-50 cursor-pointer transition-all duration-300">
                        <input type="checkbox" name="channels" value="email" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="ml-3 flex items-center">
                            <i class="fas fa-envelope mr-2 text-green-500"></i>‚úâÔ∏è {% trans "Email" %}
                        </span>
                    </label>
                    <label class="inline-flex items-center p-3 border-2 rounded-xl hover:bg-green-50 cursor-pointer transition-all duration-300">
                        <input type="checkbox" name="channels" value="whatsapp" class="form-checkbox h-5 w-5 text-green-600">
                        <span class="ml-3 flex items-center">
                            <i class="fab fa-whatsapp mr-2 text-green-500"></i>{% trans "WhatsApp" %}
                        </span>
                    </label>
                    <label class="inline-flex items-center p-3 border-2 rounded-xl hover:bg-purple-50 cursor-pointer transition-all duration-300">
                        <input type="checkbox" name="channels" value="app_push" class="form-checkbox h-5 w-5 text-purple-600">
                        <span class="ml-3 flex items-center">
                            <i class="fas fa-mobile-alt mr-2 text-purple-500"></i>{% trans "App Push" %}
                        </span>
                    </label>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-8 border-t border-gray-200">
                <a href="{% url 'fines:fine_history' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105">
                    <i class="fas fa-times mr-2"></i>{% trans "Cancel" %}
                </a>
                <button type="submit" onclick="return validateAndSubmit()" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-exclamation-triangle mr-2"></i>{% trans "Apply Fine" %}
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get DOM elements
        const targetScopeRadios = document.querySelectorAll('input[name="target_scope"]');
        const studentField = document.getElementById('student-field');
        const classField = document.getElementById('class-field');
        const fineTypeSelect = document.getElementById('id_fine_type');
        const fineTypeDescription = document.getElementById('fine-type-description');
        const feesGroupSelect = document.getElementById('id_fees_group');
        const feesTypeSelect = document.getElementById('id_fees_type');
        const feesTypeInfo = document.getElementById('fees-type-info');
        const classSectionSelect = document.getElementById('id_class_section');
        const reasonTextarea = document.getElementById('id_reason');
        const studentSearch = document.getElementById('student-search');
        const studentList = document.getElementById('student-list');
        const selectedStudentsList = document.getElementById('selected-students-list');
        const selectedStudentsInput = document.getElementById('selected_students_input');

        // Store selected students
        let selectedStudents = new Set();

        // Load fine type descriptions via AJAX
        let fineTypeDescriptions = {};
        
        // Load fine types and descriptions
        function loadFineTypes() {
            fetch('{% url "fines:ajax_load_fees_types" %}?fees_group_id=')
                .then(response => response.json())
                .then(data => {
                    // This will be populated when we have fine type data
                })
                .catch(error => console.error('Error loading fine types:', error));
        }

        // Toggle fields based on target scope
        function toggleFields() {
            const selectedScope = document.querySelector('input[name="target_scope"]:checked');
            if (!selectedScope) return;
            
            const scope = selectedScope.value;
            console.log('Target scope changed to:', scope);

            // Hide all conditional fields first
            studentField.classList.add('hidden');
            classField.classList.add('hidden');

            // Show appropriate field based on scope
            if (scope === 'Individual') {
                studentField.classList.remove('hidden');
                loadAllStudents();
            } else if (scope === 'Class') {
                classField.classList.remove('hidden');
                loadAllClasses();
                // Make class_section field required
                classSectionSelect.required = true;
            } else {
                // For 'All' scope, class_section is not required
                classSectionSelect.required = false;
            }
        }

        // Load all students
        function loadAllStudents() {
            fetch(`{% url 'fines:ajax_load_students_for_fees_type' %}?fees_type_id=`)
                .then(response => response.json())
                .then(data => {
                    displayStudents(data.students || []);
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    studentList.innerHTML = '<p class="text-red-500">Error loading students</p>';
                });
        }

        // Display students in the list
        function displayStudents(students) {
            studentList.innerHTML = '';
            
            if (students.length === 0) {
                studentList.innerHTML = '<p class="text-gray-500">No students found</p>';
                return;
            }

            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer';
                studentDiv.innerHTML = `
                    <input type="checkbox" id="student-${student.id}" value="${student.id}" class="mr-3">
                    <label for="student-${student.id}" class="flex-1 cursor-pointer">
                        <div class="font-medium">${student.name}</div>
                        <div class="text-sm text-gray-500">
                            Admission: ${student.admission_number || 'N/A'} | 
                            Class: ${student.class_name || 'N/A'} | 
                            Father: ${student.father_name || 'N/A'}
                        </div>
                    </label>
                `;
                
                const checkbox = studentDiv.querySelector('input[type="checkbox"]');
                
                // Check if this student was previously selected
                if (selectedStudents.has(student.id)) {
                    checkbox.checked = true;
                }
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedStudents.add(student.id);
                    } else {
                        selectedStudents.delete(student.id);
                    }
                    updateSelectedStudentsDisplay();
                    
                    // Hide validation error when students are selected
                    const validationError = document.getElementById('student-validation-error');
                    if (validationError && selectedStudents.size > 0) {
                        validationError.classList.add('hidden');
                    }
                });
                
                studentList.appendChild(studentDiv);
            });
        }

        // Update selected students display
        function updateSelectedStudentsDisplay() {
            selectedStudentsList.innerHTML = '';
            const selectedArray = Array.from(selectedStudents);
            selectedStudentsInput.value = selectedArray.join(',');
            
            if (selectedArray.length === 0) {
                selectedStudentsList.innerHTML = '<p class="text-gray-500">No students selected</p>';
                return;
            }

            selectedArray.forEach(studentId => {
                // Find student name from the currently displayed students
                const studentCheckbox = document.getElementById(`student-${studentId}`);
                let studentName = studentId; // fallback to ID
                
                if (studentCheckbox) {
                    const label = studentCheckbox.nextElementSibling;
                    if (label) {
                        const nameDiv = label.querySelector('.font-medium');
                        if (nameDiv) {
                            studentName = nameDiv.textContent;
                        }
                    }
                }
                
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex items-center justify-between p-2 bg-blue-50 rounded';
                studentDiv.innerHTML = `
                    <span class="text-sm font-medium">${studentName} (${studentId})</span>
                    <button type="button" onclick="removeStudent('${studentId}')" 
                            class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                `;
                selectedStudentsList.appendChild(studentDiv);
            });
        }

        // Remove student from selection
        window.removeStudent = function(studentId) {
            selectedStudents.delete(studentId);
            const checkbox = document.getElementById(`student-${studentId}`);
            if (checkbox) checkbox.checked = false;
            updateSelectedStudentsDisplay();
        };

        // Search students
        function searchStudents(searchTerm) {
            if (searchTerm.length < 2) {
                loadAllStudents();
                return;
            }

            fetch(`{% url 'fines:ajax_search_students' %}?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    displayStudents(data.students || []);
                })
                .catch(error => {
                    console.error('Error searching students:', error);
                    studentList.innerHTML = '<p class="text-red-500">Error searching students</p>';
                });
        }

        // Update fine type description and populate reason field
        function updateFineTypeDescription() {
            const selectedId = fineTypeSelect.value;
            const description = fineTypeDescriptions[selectedId] || 'No description available';
            fineTypeDescription.textContent = description;
            
            // Populate reason field with fine type description if it's empty
            if (selectedId && (!reasonTextarea.value || reasonTextarea.value.trim() === '')) {
                reasonTextarea.value = description;
            }
        }

        // Update fees type dropdown based on selected group
        function updateFeesTypes() {
            const groupId = feesGroupSelect.value;

            // Reset fees type select
            feesTypeSelect.innerHTML = '<option value="">Select Fees Type</option>';
            feesTypeSelect.disabled = !groupId;

            if (groupId) {
                // Show loading state
                feesTypeSelect.innerHTML = '<option value="">Loading...</option>';
                
                // Make AJAX call to get fees types
                fetch(`{% url 'fines:ajax_load_fees_types' %}?fees_group_id=${groupId}`)
                    .then(response => response.json())
                    .then(data => {
                        feesTypeSelect.innerHTML = '<option value="">Select Fees Type</option>';
                        
                        if (data.fees_types && data.fees_types.length > 0) {
                            data.fees_types.forEach(function(feesType) {
                                const option = document.createElement('option');
                                option.value = feesType.id;
                                
                                // Format: Fee Group | Class/Stoppage | Amount Type | Amount
                                const classStoppage = feesType.class_name || feesType.stoppage_name || 'General';
                                const displayText = `${feesType.group_type} | ${classStoppage} | ${feesType.amount_type} | ‚Çπ${feesType.amount}`;
                                
                                option.textContent = displayText;
                                option.dataset.amount = feesType.amount;
                                option.dataset.className = feesType.class_name || '';
                                option.dataset.groupType = feesType.group_type || '';
                                option.dataset.amountType = feesType.amount_type || '';
                                feesTypeSelect.appendChild(option);
                            });
                        } else {
                            feesTypeSelect.innerHTML = '<option value="">No fees types available</option>';
                        }
                        
                        feesTypeSelect.disabled = false;
                        updateFeesTypeInfo();
                    })
                    .catch(error => {
                        console.error('Error loading fees types:', error);
                        feesTypeSelect.innerHTML = '<option value="">Error loading fees types</option>';
                        feesTypeSelect.disabled = true;
                    });
            } else {
                feesTypeSelect.disabled = true;
                updateFeesTypeInfo();
            }
        }

        // Load all classes
        function loadAllClasses() {
            fetch(`{% url 'fines:ajax_load_classes_for_fees_type' %}?fees_type_id=`)
                .then(response => response.json())
                .then(data => {
                    classSectionSelect.innerHTML = '<option value="">Select Class</option>';
                    
                    if (data.classes && data.classes.length > 0) {
                        data.classes.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.id;
                            option.textContent = cls.name;
                            classSectionSelect.appendChild(option);
                        });
                    } else {
                        classSectionSelect.innerHTML = '<option value="">No classes available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading classes:', error);
                    classSectionSelect.innerHTML = '<option value="">Error loading classes</option>';
                });
        }

        // Update fees type info
        function updateFeesTypeInfo() {
            const selectedOption = feesTypeSelect.options[feesTypeSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.amount) {
                feesTypeInfo.textContent = `Amount: ‚Çπ${selectedOption.dataset.amount}`;
            } else {
                feesTypeInfo.textContent = '';
            }
        }

        // Set default due date to 20th of current month
        function setDefaultDueDate() {
            const dueDateInput = document.getElementById('id_due_date');
            if (!dueDateInput.value) {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const defaultDate = new Date(currentYear, currentMonth, 20);
                dueDateInput.value = defaultDate.toISOString().split('T')[0];
            }
        }

        // Initialize
        setDefaultDueDate();
        toggleFields();
        updateFineTypeDescription();
        updateFeesTypes();
        loadAllStudents();

        // Event listeners
        targetScopeRadios.forEach(radio => {
            radio.addEventListener('change', toggleFields);
        });

        fineTypeSelect.addEventListener('change', updateFineTypeDescription);
        feesGroupSelect.addEventListener('change', function() {
            updateFeesTypes();
            feesTypeSelect.value = '';
            updateFeesTypeInfo();
        });
        
        feesTypeSelect.addEventListener('change', updateFeesTypeInfo);
        
        // Student search functionality
        let searchTimeout;
        if (studentSearch) {
            studentSearch.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchStudents(this.value);
                }, 300);
            });
        }

        // Validation function for submit button
        window.validateAndSubmit = function() {
            const selectedScope = document.querySelector('input[name="target_scope"]:checked');
            
            if (!selectedScope) {
                alert('Please select a target scope.');
                return false;
            }
            
            console.log('Validating form with scope:', selectedScope.value);
            
            if (selectedScope.value === 'Individual') {
                const selectedArray = Array.from(selectedStudents);
                selectedStudentsInput.value = selectedArray.join(',');
                
                if (selectedStudents.size === 0) {
                    alert('Please select at least one student.');
                    return false;
                }
            } else if (selectedScope.value === 'Class') {
                const classSectionValue = classSectionSelect.value;
                console.log('Class section value:', classSectionValue);
                
                if (!classSectionValue) {
                    alert('Please select a class section.');
                    classSectionSelect.focus();
                    return false;
                }
            }
            
            return true;
        };
    });
</script>
{% endblock %}
{% endblock %}