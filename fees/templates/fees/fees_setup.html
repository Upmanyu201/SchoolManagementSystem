{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load permission_tags %}

{% block title %}{% trans "Fees Setup" %} - {{ school_name|default:"School Management" }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/hide-export-buttons.css' %}">
<script src="{% static 'js/hide-export-buttons.js' %}"></script>
<div class="animate-fade-in">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-blue-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-money-check-alt text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-800 bg-clip-text text-transparent">
                        {% trans "Fees Setup & Management" %}
                    </h1>
                    <p class="text-gray-600 mt-1">{% trans "Configure fee groups, types, and amounts" %}</p>
                </div>
            </div>
            <a href="{% url 'dashboard' %}" 
               class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                <i class="fas fa-home mr-2"></i>{% trans "Dashboard" %}
            </a>
        </div>
    </div>



    <!-- Messages -->
    {% if messages %}
    <div id="form-messages" class="fixed top-20 right-4 z-50 space-y-2 max-w-md">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-500{% else %}bg-green-500{% endif %} text-white p-4 rounded-xl shadow-lg animate-slide-in message-item" data-message-id="{{ forloop.counter }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} mr-3"></i>
                    <span class="font-medium">{{ message }}</span>
                </div>
                <button onclick="removeMessage(this)" class="ml-3 text-white hover:text-gray-200 font-bold">
                    ×
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Quick Actions Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-200">
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 rounded-xl mb-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-bolt mr-3"></i>{% trans "Quick Actions" %}
            </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% if user|can_edit_module:'fees' %}
            <a href="{% url 'fees:add_fees_group' %}" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                <i class="fas fa-plus-circle text-2xl mb-2 block"></i>
                {% trans "Add Fees Group" %}
            </a>
            <a href="{% url 'fees:add_fees_type' %}" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                <i class="fas fa-tags text-2xl mb-2 block"></i>
                {% trans "Add Fees Type" %}
            </a>
            <a href="{% url 'fees:fees_carry_forward' %}" class="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                <i class="fas fa-forward text-2xl mb-2 block"></i>
                {% trans "Fees Carry Forward" %}
            </a>
            {% endif %}
            {% if user|can_edit_module:'fines' %}
            <a href="{% url 'fines:base_fine' %}" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                <i class="fas fa-exclamation-triangle text-2xl mb-2 block"></i>
                {% trans "Manage Fines" %}
            </a>
            {% endif %}
            {% if not user|can_edit_module:'fees' and user|can_access_module:'fees' %}
            <div class="bg-gray-100 text-gray-500 font-bold py-4 px-6 rounded-xl text-center">
                <i class="fas fa-eye text-2xl mb-2 block"></i>
                {% trans "View-only access" %}
            </div>
            {% endif %}
        </div>
        
        <!-- Export Buttons -->
        {% if user|can_access_module:'fees' %}
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex flex-wrap gap-3">
                <button onclick="exportData('csv', 'fee_structure')" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export Fee Structure to CSV">
                    <i class="fas fa-file-csv mr-2"></i>Fee Structure CSV
                </button>
                <button onclick="exportData('excel', 'fee_structure')" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export Fee Structure to Excel">
                    <i class="fas fa-file-excel mr-2"></i>Fee Structure Excel
                </button>
                <button onclick="exportData('pdf', 'fee_structure')" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg" title="Export Fee Structure to PDF">
                    <i class="fas fa-file-pdf mr-2"></i>Fee Structure PDF
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Search & Filter Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-200">
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 rounded-xl mb-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-search mr-3"></i>{% trans "Search & Filter Fees" %}
            </h2>
        </div>
        
        <form method="get" class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <!-- Search by Group/Type -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-search mr-2 text-purple-500"></i>{% trans "Group/Type" %}
                </label>
                <input type="text" name="q" placeholder="{% trans 'Search by Group or Type' %}" value="{{ search_query }}"
                    class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:ring-0 transition-all duration-300">
            </div>

            <!-- Amount Type -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-dollar-sign mr-2 text-green-500"></i>{% trans "Amount Type" %}
                </label>
                <input type="text" name="amount_type" placeholder="{% trans 'Search by Amount Type' %}" value="{{ request.GET.amount_type }}"
                    class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:ring-0 transition-all duration-300">
            </div>

            <!-- Amount -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2 flex items-center">
                    <i class="fas fa-money-bill mr-2 text-blue-500"></i>{% trans "Amount" %}
                </label>
                <input type="number" name="amount" placeholder="{% trans 'Search by Amount' %}" value="{{ request.GET.amount }}"
                    class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:ring-0 transition-all duration-300">
            </div>

            <!-- Search Button -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-search mr-2"></i>{% trans "Search" %}
                </button>
            </div>

            <!-- Clear Button -->
            <div class="form-group">
                <label class="block text-gray-700 font-semibold mb-2">&nbsp;</label>
                <a href="{% url 'fees:fees_setup' %}" class="block w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 text-center">
                    <i class="fas fa-times mr-2"></i>{% trans "Clear" %}
                </a>
            </div>
        </form>
    </div>

    <!-- Fees Types Table -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-tags mr-3"></i>{% trans "Fees Types" %}
            </h2>
        </div>
        
        <!-- Page Size Control -->
        <div class="bg-gray-50 p-4 border-b">
            <form method="get" class="flex items-center justify-between">
                <!-- Preserve all existing filters -->
                <input type="hidden" name="q" value="{{ search_query }}">
                <input type="hidden" name="class_name" value="{{ class_query }}">
                <input type="hidden" name="amount_type" value="{{ request.GET.amount_type }}">
                <input type="hidden" name="amount" value="{{ request.GET.amount }}">

                <div class="flex items-center gap-4">
                    <span class="text-gray-700 font-semibold flex items-center">
                        <i class="fas fa-list mr-2 text-blue-500"></i>{% trans "Show" %}
                    </span>
                    <select name="page_size" onchange="this.form.submit()" class="border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-blue-400 transition-colors">
                        <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
                    </select>
                    <span class="text-gray-700 font-semibold">{% trans "per page" %}</span>
                </div>
                <div class="text-sm text-gray-600">
                    {% if fee_types %}
                        {% trans "Showing" %} {{ fee_types.start_index }}-{{ fee_types.end_index }} {% trans "of" %} {{ fee_types.paginator.count }} {% trans "fee types" %}
                    {% endif %}
                </div>
            </form>
        </div>
        
        <!-- Bulk Actions -->
        {% if user|can_edit_module:'fees' %}
        <div class="bg-gray-50 p-4 border-b flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="bulkDeleteBtn" onclick="bulkDeleteSelected()" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-trash-alt mr-2"></i>{% trans "Delete Selected" %}
                </button>
                <span id="selectedCount" class="text-sm text-gray-600">0 {% trans "selected" %}</span>
            </div>
        </div>
        {% endif %}
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        {% if user|can_edit_module:'fees' %}
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="selectAll" class="ml-2 text-sm font-medium text-gray-900">{% trans "Select All" %}</label>
                        </th>
                        {% endif %}
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-layer-group mr-2 text-purple-500"></i>{% trans "Group Type" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-users mr-2 text-blue-500"></i>{% trans "Fee Group" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-tag mr-2 text-green-500"></i>{% trans "Class/Stoppage" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-dollar-sign mr-2 text-yellow-500"></i>{% trans "Amount Type" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-money-bill mr-2 text-teal-500"></i>{% trans "Amount" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-cogs mr-2 text-red-500"></i>{% trans "Actions" %}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for fee in fee_types %}
                    <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-300">
                        {% if user|can_edit_module:'fees' %}
                        <td class="px-6 py-4">
                            <input type="checkbox" class="fee-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="{{ fee.id }}">
                        </td>
                        {% endif %}
                        <td class="px-6 py-4">
                            <span class="badge badge-primary">{{ fee.group_type }}</span>
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-900">{{ fee.fee_group }}</td>
                        <td class="px-6 py-4 text-gray-700">
                            {% if fee.class_name %}
                                <span class="badge badge-info">{{ fee.class_name }}</span>
                            {% elif fee.stoppage_name %}
                                <span class="badge badge-warning">{{ fee.stoppage_name }}</span>
                            {% else %}
                                {{ fee.fee_type }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="badge badge-warning">{{ fee.amount_type }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-mono text-lg font-bold text-green-600">₹{{ fee.amount }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                {% if user|can_edit_module:'fees' %}
                                <a href="{% url 'fees:edit_fees_type' fee.id %}"
                                    class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="showDeleteModal('{{ fee.fee_type }}', '{{ fee.fee_group }}', '{% url 'fees:delete_fees_type' fee.id %}')"
                                    class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% elif user|can_access_module:'fees' %}
                                <span class="text-gray-500 px-3 py-2">
                                    <i class="fas fa-eye mr-1"></i>View only
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-tags text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-500 mb-2">{% trans "No Fee Types Found" %}</h3>
                                <p class="text-gray-400 mb-4">{% trans "No fee types have been configured yet" %}</p>
                                {% if user|can_edit_module:'fees' %}
                                <a href="{% url 'fees:add_fees_type' %}" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-plus mr-2"></i>{% trans "Add First Fee Type" %}
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination for Fees Types -->
        {% if fee_types.has_other_pages %}
        <div class="bg-gray-50 p-6 border-t">
            <nav class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    {% if fee_types.has_previous %}
                    <a href="?page=1&type_page={{ fee_types.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fas fa-angle-double-left mr-2"></i>{% trans "First" %}
                    </a>
                    <a href="?page={{ fee_types.previous_page_number }}&type_page={{ fee_types.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fas fa-chevron-left mr-2"></i>{% trans "Previous" %}
                    </a>
                    {% endif %}
                </div>
                
                <div class="flex items-center gap-2">
                    {% for num in fee_types.paginator.page_range %}
                        {% if fee_types.number == num %}
                        <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-lg font-bold">
                            {{ num }}
                        </span>
                        {% elif num > fee_types.number|add:'-3' and num < fee_types.number|add:'3' %}
                        <a href="?page={{ num }}&type_page={{ fee_types.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                           class="bg-gray-100 hover:bg-gradient-to-r hover:from-blue-500 hover:to-indigo-600 hover:text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="flex items-center gap-2">
                    {% if fee_types.has_next %}
                    <a href="?page={{ fee_types.next_page_number }}&type_page={{ fee_types.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        {% trans "Next" %}<i class="fas fa-chevron-right ml-2"></i>
                    </a>
                    <a href="?page={{ fee_types.paginator.num_pages }}&type_page={{ fee_types.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        {% trans "Last" %}<i class="fas fa-angle-double-right ml-2"></i>
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}
    </div>

    <!-- Fees Groups Table -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 mb-8">
        <div class="bg-gradient-to-r from-green-500 to-teal-600 p-6">
            <h2 class="text-white text-xl font-bold flex items-center">
                <i class="fas fa-users mr-3"></i>{% trans "Fees Groups" %}
            </h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-layer-group mr-2 text-purple-500"></i>{% trans "Group Type" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-users mr-2 text-blue-500"></i>{% trans "Fee Group" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-tag mr-2 text-green-500"></i>{% trans "Fee Type" %}
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                            <i class="fas fa-cogs mr-2 text-red-500"></i>{% trans "Actions" %}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in fee_groups %}
                    <tr class="hover:bg-gradient-to-r hover:from-green-50 hover:to-teal-50 transition-all duration-300">
                        <td class="px-6 py-4">
                            <span class="badge badge-success">{{ group.group_type }}</span>
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-900">{{ group.fee_group }}</td>
                        <td class="px-6 py-4 text-gray-700">
                            {% if group.fee_type == 'Class Based' and group.related_class %}
                            <span class="badge badge-info">{{ group.related_class.name }}</span>
                            {% elif group.fee_type == 'Stoppage Based' and group.related_stoppage %}
                            <span class="badge badge-warning">{{ group.related_stoppage.name }}</span>
                            {% else %}
                            <span class="badge badge-secondary">{{ group.fee_type }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                {% if user|can_edit_module:'fees' %}
                                <a href="{% url 'fees:edit_fees_group' group.id %}"
                                    class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="showDeleteGroupModal('{{ group.fee_group }}', '{{ group.group_type }}', '{% url 'fees:delete_fees_group' group.id %}')"
                                    class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% elif user|can_access_module:'fees' %}
                                <span class="text-gray-500 px-3 py-2">
                                    <i class="fas fa-eye mr-1"></i>View only
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-500 mb-2">{% trans "No Fee Groups Found" %}</h3>
                                <p class="text-gray-400 mb-4">{% trans "No fee groups have been configured yet" %}</p>
                                {% if user|can_edit_module:'fees' %}
                                <a href="{% url 'fees:add_fees_group' %}" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-plus mr-2"></i>{% trans "Add First Fee Group" %}
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination for Fees Groups -->
        {% if fee_groups.has_other_pages %}
        <div class="bg-gray-50 p-6 border-t">
            <nav class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    {% if fee_groups.has_previous %}
                    <a href="?type_page=1&page={{ fee_groups.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fas fa-angle-double-left mr-2"></i>{% trans "First" %}
                    </a>
                    <a href="?type_page={{ fee_groups.previous_page_number }}&page={{ fee_groups.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fas fa-chevron-left mr-2"></i>{% trans "Previous" %}
                    </a>
                    {% endif %}
                </div>
                
                <div class="flex items-center gap-2">
                    {% for num in fee_groups.paginator.page_range %}
                        {% if fee_groups.number == num %}
                        <span class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-4 py-2 rounded-lg font-bold">
                            {{ num }}
                        </span>
                        {% elif num > fee_groups.number|add:'-3' and num < fee_groups.number|add:'3' %}
                        <a href="?type_page={{ num }}&page={{ fee_groups.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                           class="bg-gray-100 hover:bg-gradient-to-r hover:from-green-500 hover:to-teal-600 hover:text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="flex items-center gap-2">
                    {% if fee_groups.has_next %}
                    <a href="?type_page={{ fee_groups.next_page_number }}&page={{ fee_groups.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        {% trans "Next" %}<i class="fas fa-chevron-right ml-2"></i>
                    </a>
                    <a href="?type_page={{ fee_groups.paginator.num_pages }}&page={{ fee_groups.number }}&q={{ search_query }}&amount_type={{ request.GET.amount_type }}&amount={{ request.GET.amount }}"
                       class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        {% trans "Last" %}<i class="fas fa-angle-double-right ml-2"></i>
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}
    </div>

</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 border border-gray-200">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">{% trans "Confirm Deletion" %}</h3>
            <p class="text-gray-600">
                {% trans "Are you sure you want to delete" %} <span id="itemName" class="font-semibold text-red-600"></span>?
            </p>
            <p class="text-sm text-gray-500 mt-2">
                {% trans "Type:" %} <span id="itemType" class="font-semibold"></span>
            </p>
        </div>
        <div class="flex gap-4">
            <button onclick="hideDeleteModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-xl transition-all duration-300">
                <i class="fas fa-times mr-2"></i>{% trans "Cancel" %}
            </button>
            <form id="deleteForm" method="POST" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-trash-alt mr-2"></i>{% trans "Delete" %}
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div id="bulkDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 border border-gray-200">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">{% trans "Confirm Bulk Deletion" %}</h3>
            <p class="text-gray-600">
                {% trans "Are you sure you want to delete" %} <span id="bulkItemCount" class="font-semibold text-red-600"></span> {% trans "fee type(s)" %}?
            </p>
            <p class="text-sm text-gray-500 mt-2">
                {% trans "This action cannot be undone." %}
            </p>
        </div>
        <div class="flex gap-4">
            <button onclick="hideBulkDeleteModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-xl transition-all duration-300">
                <i class="fas fa-times mr-2"></i>{% trans "Cancel" %}
            </button>
            <button onclick="confirmBulkDelete()" class="flex-1 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-trash-alt mr-2"></i>{% trans "Delete All" %}
            </button>
        </div>
    </div>
</div>

<script>
function showDeleteModal(itemName, itemType, deleteUrl) {
    document.getElementById('itemName').textContent = itemName;
    document.getElementById('itemType').textContent = itemType;
    document.getElementById('deleteForm').action = deleteUrl;
    document.getElementById('deleteModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

function showDeleteGroupModal(groupName, groupType, deleteUrl) {
    showDeleteModal(groupName, groupType, deleteUrl);
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function (e) {
    if (e.target === this) {
        hideDeleteModal();
    }
});

// Bulk delete functionality
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.fee-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count + ' selected';
    document.getElementById('bulkDeleteBtn').disabled = count === 0;
}

function bulkDeleteSelected() {
    const checkboxes = document.querySelectorAll('.fee-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one fee type to delete.');
        return;
    }
    
    document.getElementById('bulkItemCount').textContent = checkboxes.length;
    document.getElementById('bulkDeleteModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
}

function hideBulkDeleteModal() {
    document.getElementById('bulkDeleteModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

function confirmBulkDelete() {
    const checkboxes = document.querySelectorAll('.fee-checkbox:checked');
    const feeTypeIds = Array.from(checkboxes).map(cb => cb.value);
    
    // Create form data instead of JSON
    const formData = new FormData();
    feeTypeIds.forEach(id => {
        formData.append('selected_fees', id);
    });
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "fees:bulk_delete_fees_type" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting fee types.');
    });
    
    hideBulkDeleteModal();
}

// Message handling functions
function removeMessage(button) {
    const messageItem = button.closest('.message-item');
    messageItem.style.opacity = '0';
    messageItem.style.transform = 'translateX(100%)';
    setTimeout(() => {
        messageItem.remove();
        // Remove container if no messages left
        const container = document.getElementById('form-messages');
        if (container && container.children.length === 0) {
            container.remove();
        }
    }, 300);
}

// Auto-hide messages
document.addEventListener('DOMContentLoaded', function() {
    const messageItems = document.querySelectorAll('.message-item');
    messageItems.forEach((item, index) => {
        setTimeout(() => {
            if (item.parentNode) { // Check if still exists
                removeMessage(item.querySelector('button'));
            }
        }, 4000 + (index * 500)); // Stagger removal
    });
    
    // Select all functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const feeCheckboxes = document.querySelectorAll('.fee-checkbox');
    
    selectAllCheckbox.addEventListener('change', function() {
        feeCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // Individual checkbox change
    feeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            
            // Update select all checkbox
            const checkedCount = document.querySelectorAll('.fee-checkbox:checked').length;
            selectAllCheckbox.checked = checkedCount === feeCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < feeCheckboxes.length;
        });
    });
    
    // Animate table rows on load
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'all 0.5s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
});

// Export functionality
function exportData(format, dataType) {
    console.log('🚀 [FEES SETUP EXPORT] Starting export process', {
        format: format,
        dataType: dataType,
        timestamp: new Date().toISOString(),
        module: 'fees'
    });
    
    const searchQuery = '{{ search_query|default:"" }}';
    const amountType = '{{ request.GET.amount_type|default:"" }}';
    const amount = '{{ request.GET.amount|default:"" }}';
    
    console.log('📊 [FEES SETUP EXPORT] Export filters:', {
        searchQuery: searchQuery,
        amountType: amountType,
        amount: amount,
        format: format,
        dataType: dataType
    });
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;
    
    console.log('🔄 [FEES SETUP EXPORT] Button state changed to loading');
    
    // Prepare export data
    const exportData = {
        module: 'fees',
        data_type: dataType,
        format: format,
        filters: {
            search: searchQuery,
            amount_type: amountType,
            amount: amount
        }
    };
    
    console.log('📦 [FEES SETUP EXPORT] Prepared export data:', exportData);
    
    // Call export API
    const formData = new FormData();
    formData.append('module', exportData.module);
    formData.append('data_type', exportData.data_type);
    formData.append('format', exportData.format);
    formData.append('filters', JSON.stringify(exportData.filters));
    
    // Get CSRF token properly
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                     getCookie('csrftoken');
    
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken);
    }
    
    console.log('🌐 [FEES SETUP EXPORT] Sending API request to /api/export/initiate/');
    
    fetch('/api/export/initiate/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('📡 [FEES SETUP EXPORT] API Response received:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('✅ [FEES SETUP EXPORT] API Response data:', data);
        
        if (data.request_id) {
            console.log('🎯 [FEES SETUP EXPORT] Export request initiated successfully:', {
                requestId: data.request_id,
                format: format,
                dataType: dataType
            });
            
            // Show success message
            showNotification('Export initiated successfully! Download will start shortly.', 'success');
            
            // Check status and download
            checkExportStatus(data.request_id, format);
        } else {
            console.error('❌ [FEES SETUP EXPORT] Export failed - no request ID:', data);
            showNotification('Export failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('💥 [FEES SETUP EXPORT] Export error:', {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
        });
        showNotification('Export failed: Network error', 'error');
    })
    .finally(() => {
        console.log('🔄 [FEES SETUP EXPORT] Restoring button state');
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function checkExportStatus(requestId, format) {
    console.log('⏳ [FEES SETUP EXPORT] Starting status check for request:', requestId);
    
    const checkStatus = () => {
        console.log('🔍 [FEES SETUP EXPORT] Checking export status...', {
            requestId: requestId,
            timestamp: new Date().toISOString()
        });
        
        fetch(`/api/export/status/${requestId}/`)
        .then(response => {
            console.log('📡 [FEES SETUP EXPORT] Status check response:', {
                status: response.status,
                ok: response.ok
            });
            return response.json();
        })
        .then(data => {
            console.log('📊 [FEES SETUP EXPORT] Status data received:', data);
            
            if (data.status === 'completed') {
                console.log('✅ [FEES SETUP EXPORT] Export completed successfully!');
                // Download the file
                window.location.href = `/api/export/download/${requestId}/`;
                showNotification(`${format.toUpperCase()} export completed!`, 'success');
            } else if (data.status === 'failed') {
                console.error('❌ [FEES SETUP EXPORT] Export failed:', data.error);
                showNotification('Export failed: ' + (data.error || 'Processing error'), 'error');
            } else {
                console.log('⏳ [FEES SETUP EXPORT] Still processing, checking again in 2s...', {
                    currentStatus: data.status
                });
                // Still processing, check again
                setTimeout(checkStatus, 2000);
            }
        })
        .catch(error => {
            console.error('💥 [FEES SETUP EXPORT] Status check error:', {
                error: error.message,
                requestId: requestId,
                timestamp: new Date().toISOString()
            });
            showNotification('Failed to check export status', 'error');
        });
    };
    
    // Start checking after 1 second
    setTimeout(checkStatus, 1000);
}

function showNotification(message, type) {
    console.log('🔔 [FEES SETUP EXPORT] Showing notification:', {
        message: message,
        type: type,
        timestamp: new Date().toISOString()
    });
    
    // Remove existing notifications to prevent overlap
    const existingNotifications = document.querySelectorAll('.export-notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `export-notification fixed top-32 right-4 z-50 p-4 rounded-xl shadow-lg animate-slide-in max-w-md ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'
                } mr-3"></i>
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200 font-bold">
                ×
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            console.log('🗑️ [FEES SETUP EXPORT] Removing notification');
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) notification.remove();
            }, 300);
        }
    }, 4000);
}

// Close modals when clicking outside
document.getElementById('bulkDeleteModal').addEventListener('click', function (e) {
    if (e.target === this) {
        hideBulkDeleteModal();
    }
});

// Helper function to get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% block extra_css %}
<style>
@keyframes slide-in {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.animate-slide-in {
    animation: slide-in 0.3s ease-out;
}

.animate-fade-in {
    animation: fadeIn 0.8s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced form styling */
.form-input {
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    box-shadow: inset 2px 2px 5px #e2e8f0, inset -2px -2px 5px #ffffff;
}

.form-input:focus {
    background: #ffffff;
    box-shadow: 0 0 20px rgba(147, 51, 234, 0.15);
}

/* Table enhancements */
.table tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Badge styling */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-primary {
    background: linear-gradient(135deg, #3B82F6, #1D4ED8);
    color: white;
}

.badge-success {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
}

.badge-warning {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
}

.badge-info {
    background: linear-gradient(135deg, #06B6D4, #0891B2);
    color: white;
}

.badge-secondary {
    background: linear-gradient(135deg, #6B7280, #4B5563);
    color: white;
}
</style>
{% endblock %}
{% endblock %}